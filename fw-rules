
#!/bin/sh
#constantes
WAN_IFACE="eth0"
case "$1" in
start)
	echo "Starting fw-rules "
	echo "1" > /proc/sys/net/ipv4/ip_forward
	iptables -t nat -F
	iptables -F OUTPUT
	iptables -F INPUT
	iptables -F FORWARD
	iptables -P INPUT DROP
	iptables -P FORWARD DROP
	iptables -P OUTPUT DROP
	iptables -A FORWARD -o $WAN_IFACE -j ACCEPT
	iptables -t nat -A POSTROUTING -o $WAN_IFACE -j MASQUERADE 
	iptables -A FORWARD -p tcp -s LAN -d DMZ -j ACCEPT
	iptables -A FORWARD -o eth0 -p tcp -s LAN -j ACCEPT
	iptables -A FORWARD -s DMZ -d LAN -p icmp -j ACCEPT
	iptables -A FORWARD -p tcp --dport 80 -s DMZ -j ACCEPT
	iptables -A FORWARD -p tcp --dport 443 -s DMZ -j ACCEPT
	iptables -A FORWARD -p tcp --sport 80 -d DMZ -j ACCEPT
	iptables -A FORWARD -p tcp --sport 443 -d DMZ -j ACCEPT
	iptables -A OUTPUT -p tcp --dport 80 -s DMZ -j ACCEPT
	iptables -A OUTPUT -p tcp --dport 443 -s DMZ -j ACCEPT
	iptables -A FORWARD -p icmp -s DMZ -j ACCEPT
	iptables -A OUTPUT -p icmp -s DMZ -j ACCEPT
	iptables -A FORWARD -p udp --dport 53 -s DMZ -j ACCEPT
	iptables -A FORWARD -p udp --sport 53 -d DMZ -j ACCEPT
	iptables -A OUTPUT -p udp --dport 53 -s DMZ -j ACCEPT
	iptables -A INPUT -p tcp --dport 22 -s LAN -j ACCEPT
	iptables -A INPUT -p tcp --dport 22 -s DMZ -j ACCEPT
	iptables -A OUTPUT -p tcp --sport 22 -d DMZ -j ACCEPT
	iptalbes -A OUTPUT -p tcp --sport 22 -d LAN -j ACCEPT
	iptables -t nat -A POSTROUTING -o WAN -j MASQUERADE
	iptables -t nat -A POSTROUTING -o DMZ -j MASQUERADE
	iptables -t nat -A PREROUTING -i WAN -p tcp --dport 22 --j DNAT --to-destination 172.20.108.100:22
	;;
stop)
        echo "Stopping fw-rules"
        iptables -t nat -F POSTROUTING
        iptables -F INPUT
	iptables -F OUTPUT
	iptables -F FORWARD
        ;;
restart|reload)
        $0 stop
        $0 start
        ;;
        *)
        echo "Usage: $0 {start|stop|restart|reload}"
        exit 1
        ;;
esac
exit 0
